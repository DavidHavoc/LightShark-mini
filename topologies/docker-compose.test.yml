services:
  # 1. The "Target" service (Traffic Generator)
  # We use Nginx just to have something that listens on a port (80)
  target-app:
    image: nginx:alpine
    container_name: test-target
    ports:
      - "8080:80" # We will curl localhost:8080 to generate traffic

  # 2. LightShark (The Sniffer)
  lightshark:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: test-lightshark
    # Attach to target-app's network namespace
    network_mode: "service:target-app"
    depends_on:
      - target-app
    # Note: LightShark API (3000) is now accessible via target-app's network
    # Since we didn't map 3000 in target-app, we won't see it from host directly
    # UNLESS we add port mapping to target-app.
    # But we can't easily modify target-app's ports dynamically.

    # WORKAROUND FOR TESTING FROM HOST:
    # We must define the port mapping on the *target* container if we want to reach LightShark from host.
    # See the modified target-app below if you want to access port 3000.

    # REVISED SERVICES FOR ACCESSIBILITY
    # To make this easy to test, let's merge them conceptually for the user.
    # But since I can't redefine services, let me rewrite the file content above slightly 
    # to ensure port 3000 is exposed on the target.

  test-target-exposed:
    image: nginx:alpine
    container_name: test-target-exposed
    ports:
      - "8081:80" # Nginx
      - "3001:3000" # LightShark API (Mapped through target container)

  lightshark-tester:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: lightshark-tester
    network_mode: "service:test-target-exposed"
    cap_add:
      - NET_ADMIN
    depends_on:
      - test-target-exposed
